name: Ontology Discovery Agent

on:
  workflow_dispatch:
    inputs:
      repositories:
        description: 'Comma-separated list of repository paths or "all-hq" for all HQ repos'
        required: true
        default: 'all-hq'
      output_format:
        description: 'Output format for ontology'
        required: false
        default: 'yaml'
        type: choice
        options:
          - yaml
          - json
          - markdown
      model:
        description: 'AI model to use'
        required: false
        default: 'claude-sonnet-4-20250514'
        type: choice
        options:
          - claude-sonnet-4-20250514
          - claude-3-5-sonnet-20241022
          - gpt-4o

jobs:
  discover-ontology:
    runs-on: [self-hosted, macos, macbook]
    timeout-minutes: 60

    steps:
      - name: Checkout github-hq
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Resolve HQ repositories
        id: resolve-repos
        run: |
          if [ "${{ inputs.repositories }}" = "all-hq" ]; then
            # Find all HQ repositories
            REPOS=$(ls -d ~/0-Projects-local/*-hq 2>/dev/null | tr '\n' ',' | sed 's/,$//')
          else
            REPOS="${{ inputs.repositories }}"
          fi
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "Found repositories: $REPOS"

      - name: Generate repository summaries
        id: summaries
        run: |
          mkdir -p /tmp/ontology-discovery
          REPOS="${{ steps.resolve-repos.outputs.repos }}"
          
          # Generate summary for each repo
          for repo in $(echo "$REPOS" | tr ',' ' '); do
            if [ -d "$repo" ]; then
              REPO_NAME=$(basename "$repo")
              echo "=== Processing $REPO_NAME ===" 
              
              # Create summary file
              SUMMARY_FILE="/tmp/ontology-discovery/${REPO_NAME}-summary.md"
              
              echo "# $REPO_NAME" > "$SUMMARY_FILE"
              echo "" >> "$SUMMARY_FILE"
              
              # Add README if exists
              if [ -f "$repo/README.md" ]; then
                echo "## README" >> "$SUMMARY_FILE"
                head -100 "$repo/README.md" >> "$SUMMARY_FILE"
                echo "" >> "$SUMMARY_FILE"
              fi
              
              # Add directory structure
              echo "## Directory Structure" >> "$SUMMARY_FILE"
              find "$repo" -maxdepth 2 -type f -name "*.md" -o -type f -name "*.json" -o -type f -name "*.yaml" -o -type f -name "*.yml" 2>/dev/null | head -50 >> "$SUMMARY_FILE"
              echo "" >> "$SUMMARY_FILE"
              
              # Add key config files
              if [ -f "$repo/package.json" ]; then
                echo "## package.json" >> "$SUMMARY_FILE"
                head -30 "$repo/package.json" >> "$SUMMARY_FILE"
              fi
              
              # Add frontmatter samples from md files
              echo "## Sample Frontmatter" >> "$SUMMARY_FILE"
              find "$repo" -name "*.md" -type f | head -5 | while read f; do
                echo "### $f" >> "$SUMMARY_FILE"
                head -30 "$f" >> "$SUMMARY_FILE"
                echo "" >> "$SUMMARY_FILE"
              done
            fi
          done
          
          # Combine all summaries
          cat /tmp/ontology-discovery/*-summary.md > /tmp/ontology-discovery/combined-summary.md
          echo "summary_file=/tmp/ontology-discovery/combined-summary.md" >> $GITHUB_OUTPUT

      - name: Load ontology prompt
        id: load-prompt
        run: |
          PROMPT_FILE=".github/prompts/ontology-discovery.prompt.md"
          if [ -f "$PROMPT_FILE" ]; then
            # Base64 encode to preserve formatting
            PROMPT=$(base64 < "$PROMPT_FILE")
            echo "prompt_b64=$PROMPT" >> $GITHUB_OUTPUT
          else
            echo "Error: Prompt file not found at $PROMPT_FILE"
            exit 1
          fi

      - name: Run ontology discovery
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Decode prompt
          PROMPT=$(echo "${{ steps.load-prompt.outputs.prompt_b64 }}" | base64 -d)
          
          # Append repository summaries to prompt
          SUMMARY=$(cat "${{ steps.summaries.outputs.summary_file }}")
          
          FULL_PROMPT="$PROMPT
          
          ---
          
          # Repository Analysis Input
          
          $SUMMARY
          
          ---
          
          Please analyze the above repositories and generate the recommended ontology in ${{ inputs.output_format }} format."
          
          # Use Claude API directly or via MCP
          if command -v claude &> /dev/null; then
            echo "$FULL_PROMPT" | claude --model ${{ inputs.model }} > /tmp/ontology-discovery/ontology-output.md
          else
            # Fallback: save prompt for manual execution
            echo "$FULL_PROMPT" > /tmp/ontology-discovery/ontology-prompt.md
            echo "Claude CLI not available. Prompt saved to ontology-prompt.md"
          fi

      - name: Copy results to context-hq
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          OUTPUT_DIR=~/0-Projects-local/context-hq/vault/_system/ontology-discovery
          mkdir -p "$OUTPUT_DIR"
          
          # Copy outputs
          cp /tmp/ontology-discovery/*.md "$OUTPUT_DIR/" 2>/dev/null || true
          
          # Create timestamped archive
          if [ -f /tmp/ontology-discovery/ontology-output.md ]; then
            cp /tmp/ontology-discovery/ontology-output.md "$OUTPUT_DIR/ontology-${TIMESTAMP}.md"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ontology-discovery-${{ github.run_number }}
          path: /tmp/ontology-discovery/
          retention-days: 30

      - name: Job summary
        if: always()
        run: |
          echo "## ðŸ“Š Ontology Discovery Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repositories analyzed**: ${{ steps.resolve-repos.outputs.repos }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Output format**: ${{ inputs.output_format }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Model**: ${{ inputs.model }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Output Files" >> $GITHUB_STEP_SUMMARY
          ls -la /tmp/ontology-discovery/ >> $GITHUB_STEP_SUMMARY || true
